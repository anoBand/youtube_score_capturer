<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ì•…ë³´ ì¶”ì¶œê¸°</title>
    <style>
        /* ì´ì „ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .form-container { padding: 40px; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.95em; }
        .form-group input { width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; background: #f8f9fa; transition: 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; background: white; }

        /* í”„ë¦¬ë·° ë°•ìŠ¤ */
        .preview-wrapper { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        .video-preview { width: 100%; aspect-ratio: 16 / 9; background: #000; position: relative; border-radius: 5px; overflow: hidden; }
        .selection-area { position: absolute; border: 2px solid #ff0; background: rgba(255, 255, 0, 0.2); transition: 0.2s; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .range-label { font-size: 0.8em; color: #666; margin-top: 5px; text-align: center; }

        .button-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-run { background: linear-gradient(135deg, #007bff, #6610f2); color: white; }
        .btn-download { background: linear-gradient(135deg, #fd7e14, #e83e8c); color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .status-area { margin-top: 30px; padding: 20px; border-radius: 10px; display: none; border-left: 4px solid #667eea; }
        .loading-spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) { .form-row, .form-row-4 { grid-template-columns: 1fr; } .button-group { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YouTube ì•…ë³´ ì¶”ì¶œê¸°</h1>
            <p>ì˜ì—­ê³¼ ì‹œê°„ì„ ì§€ì •í•˜ì—¬ ì•…ë³´ë¥¼ PDFë¡œ ë³€í™˜í•˜ì„¸ìš”</p>
        </div>

        <div class="form-container">
            <form id="configForm">
                <div class="form-group">
                    <label for="url">YouTube URL *</label>
                    <input type="url" id="url" name="url" required placeholder="https://www.youtube.com/watch?v=...">
                </div>

                <div class="preview-wrapper">
                    <div class="video-preview" id="videoPreview">
                        <div class="selection-area" id="selectionArea"></div>
                    </div>
                    <p style="text-align: center; font-size: 0.85em; color: #666; margin-top: 10px;">ë…¸ë€ìƒ‰ ì˜ì—­ ë‚´ì˜ ë³€í™”ë¥¼ ê°ì§€í•˜ì—¬ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
                </div>

                <div class="form-row-4">
                    <div class="form-group">
                        <label>X ì‹œì‘ (%)</label>
                        <input type="range" id="x_start" name="x_start" min="0" max="100" value="0">
                        <div class="range-label"><span id="v_x_start">0</span>%</div>
                    </div>
                    <div class="form-group">
                        <label>X ë (%)</label>
                        <input type="range" id="x_end" name="x_end" min="0" max="100" value="100">
                        <div class="range-label"><span id="v_x_end">100</span>%</div>
                    </div>
                    <div class="form-group">
                        <label>Y ì‹œì‘ (%)</label>
                        <input type="range" id="y_start" name="y_start" min="0" max="100" value="0">
                        <div class="range-label"><span id="v_y_start">0</span>%</div>
                    </div>
                    <div class="form-group">
                        <label>Y ë (%)</label>
                        <input type="range" id="y_end" name="y_end" min="0" max="100" value="100">
                        <div class="range-label"><span id="v_y_end">100</span>%</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_time">ì‹œì‘ ì‹œê°„ (mm:ss)</label>
                        <input type="text" id="start_time" name="start_time" placeholder="00:00 (ë¯¸ì…ë ¥ ì‹œ ì²˜ìŒë¶€í„°)">
                    </div>
                    <div class="form-group">
                        <label for="end_time">ì¢…ë£Œ ì‹œê°„ (mm:ss)</label>
                        <input type="text" id="end_time" name="end_time" placeholder="mm:ss (ë¯¸ì…ë ¥ ì‹œ ëê¹Œì§€)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="threshold">ê°ë„ (Threshold)</label>
                        <input type="number" id="threshold" name="threshold" step="0.1" value="5.0">
                    </div>
                    <div class="form-group">
                        <label for="frame_interval_sec">ì²˜ë¦¬ ê°„ê²© (ì´ˆ)</label>
                        <input type="number" id="frame_interval_sec" name="frame_interval_sec" step="0.1" value="1.0">
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" id="runBtn" class="btn btn-run">â–¶ï¸ ì‹¤í–‰</button>
                    <button type="button" id="downloadBtn" class="btn btn-download" disabled>ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </form>

            <div class="status-area" id="statusArea">
                <p id="statusMessage"></p>
            </div>
        </div>
    </div>

    <script>
        // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ ë¡œì§
        const selectionArea = document.getElementById('selectionArea');
        const rangeInputs = ['x_start', 'x_end', 'y_start', 'y_end'];

        function updatePreview() {
            const vals = {};
            rangeInputs.forEach(id => {
                const val = parseInt(document.getElementById(id).value);
                vals[id] = val;
                document.getElementById('v_' + id).innerText = val;
            });

            selectionArea.style.left = vals.x_start + '%';
            selectionArea.style.top = vals.y_start + '%';
            selectionArea.style.width = Math.max(0, vals.x_end - vals.x_start) + '%';
            selectionArea.style.height = Math.max(0, vals.y_end - vals.y_start) + '%';
        }

        rangeInputs.forEach(id => document.getElementById(id).addEventListener('input', updatePreview));
        updatePreview();

        // í†µì‹  ë¡œì§
        let pdfObjectURL = null;
        const configForm = document.getElementById('configForm');
        const runBtn = document.getElementById('runBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        configForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (pdfObjectURL) window.URL.revokeObjectURL(pdfObjectURL);

            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="loading-spinner"></span> ì²˜ë¦¬ ì¤‘...';
            showStatus('ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ì•…ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'processing');

            try {
                // FormDataë¥¼ ì‚¬ìš©í•˜ë©´ name ì†ì„±ì´ ìˆëŠ” ëª¨ë“  inputì´ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.
                const response = await fetch('/execute', { method: 'POST', body: new FormData(this) });

                if (response.ok) {
                    const blob = await response.blob();
                    pdfObjectURL = window.URL.createObjectURL(blob);
                    downloadBtn.disabled = false;
                    showStatus('PDF ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    // ìë™ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
                    const a = document.createElement('a');
                    a.href = pdfObjectURL;
                    a.download = 'sheet_music_score.pdf';
                    a.click();
                } else {
                    const err = await response.json();
                    showStatus('ì‹¤íŒ¨: ' + (err.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showStatus('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = 'â–¶ï¸ ì‹¤í–‰';
            }
        });

        downloadBtn.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = pdfObjectURL;
            a.download = 'sheet_music_score.pdf';
            a.click();
        });

        function showStatus(msg, type) {
            const area = document.getElementById('statusArea');
            area.style.display = 'block';
            area.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd';
            document.getElementById('statusMessage').innerHTML =
                (type === 'processing' ? '<span class="loading-spinner"></span> ' : '') + msg;
        }
    </script>
</body>
</html>